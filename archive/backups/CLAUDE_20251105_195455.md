# CLAUDE.md - ICE Development Guide

> **ðŸ”— LINKED DOCUMENTATION**: This is one of 8 essential core files that must stay synchronized. When updating this file, always cross-check and update related files: `ARCHITECTURE.md`, `README.md`, `PROJECT_STRUCTURE.md`, `ICE_DEVELOPMENT_TODO.md`, `PROJECT_CHANGELOG.md`, `ICE_PRD.md`, and `PROGRESS.md`.

**Location**: `/CLAUDE.md`
**Purpose**: Quick reference for Claude Code instances working on ICE
**Last Updated**: 2025-11-05
**Target Audience**: Claude Code AI and human developers

> **ðŸ“– For comprehensive implementation patterns**: See `CLAUDE_PATTERNS.md`
> **ðŸ“– For Docling/Crawl4AI integration details**: See `CLAUDE_INTEGRATIONS.md`
> **ðŸ“– For complete troubleshooting guide**: See `CLAUDE_TROUBLESHOOTING.md`

---

## 1. ðŸš€ QUICK REFERENCE

### Current Project Status

**Phase**: UDMA Integration Complete (Week 6/6) âœ… | 65% (91/140 tasks)

> **ðŸ“– For sprint priorities and detailed status**: See `ICE_DEVELOPMENT_TODO.md:1-60`
> **ðŸ“– For week completion tracking**: See `PROJECT_CHANGELOG.md`

### Essential Commands

**Quick Start**
```bash
export OPENAI_API_KEY="sk-..." && cd updated_architectures/implementation
python config.py  # Test configuration
python ice_simplified.py  # Run complete system
```

**Development Workflows**
```bash
jupyter notebook ice_building_workflow.ipynb  # Knowledge graph building
jupyter notebook ice_query_workflow.ipynb  # Investment intelligence analysis
export ICE_DEBUG=1 && python src/simple_demo.py  # Debug mode
```

**Testing & Validation**
```bash
python src/ice_lightrag/test_basic.py && python test_api_key.py
python tests/test_imap_email_pipeline_comprehensive.py  # IMAP tests (21 tests)
jupyter notebook ice_query_workflow.ipynb  # Portfolio analysis (11 test datasets)
```

### Critical Files Quick Reference

| File | Purpose | See Also |
|------|---------|----------|
| `ice_simplified.py` | Main orchestrator (1,366 lines) | Section 3.2 |
| `ice_building_workflow.ipynb` | Knowledge graph construction | Section 3.2 |
| `ice_query_workflow.ipynb` | Investment analysis interface | Section 3.2 |
| `ICE_PRD.md` | Complete product requirements | - |
| `ICE_DEVELOPMENT_TODO.md` | Task tracking (140 tasks) | - |
| `ICE_ARCHITECTURE_IMPLEMENTATION_PLAN.md` | UDMA guide (Option 5) | Section 2 |
| `ICE_VALIDATION_FRAMEWORK.md` | PIVF (20 golden queries) | Section 3.3 |
| `PROJECT_STRUCTURE.md` | Directory organization | - |

> **ðŸ“– For complete file catalog with descriptions**: See `PROJECT_STRUCTURE.md:268-295`
> **ðŸ“– For portfolio test datasets (11 portfolios)**: See `PROJECT_STRUCTURE.md:103-122`

---

## 2. ðŸ“‹ DEVELOPMENT CONTEXT

### What is ICE?

**Investment Context Engine (ICE)** - Modular AI system serving as cognitive backbone for boutique hedge funds (<$100M AUM), solving delayed signal capture, low insight reusability, inconsistent decision context, and manual triage bottlenecks.

> **ðŸ“– For complete product vision and user personas**: See `ICE_PRD.md:1-100`
> **ðŸ“– For detailed user personas**: See `project_information/user_research/ICE_USER_PERSONAS_DETAILED.md`

### Current Architecture

**UDMA (User-Directed Modular Architecture)** - Simple Orchestration + Production Modules

> **ðŸ“– For complete data flow diagram**: See `README.md:38-69`
> **ðŸ“– For complete UDMA implementation guide**: See `ICE_ARCHITECTURE_IMPLEMENTATION_PLAN.md`
> **ðŸ“– For architecture decision history (5 options analyzed)**: See `archive/strategic_analysis/README.md`

### Design Philosophy

**Strategic Positioning**: Professional-grade investment intelligence for boutique hedge funds at <$200/month through cost-conscious, relationship-focused architecture.

**Core Principles**: (1) Quality within resource constraints (F1â‰¥0.85, <$200/month), (2) Hidden relationships over surface facts (graph-first, 1-3 hops), (3) Fact-grounded with source attribution (100% traceability), (4) User-directed evolution (evidence-driven), (5) Simple orchestration + battle-tested modules (<2,000 lines orchestrator), (6) Cost-consciousness as design constraint (80% local LLM, semantic caching).

> **ðŸ“– For detailed philosophy**: See `project_information/development_plans/Development Brainstorm Plans (md files)/Lean_ICE_Architecture.md`

---

## 3. ðŸ› ï¸ CORE DEVELOPMENT WORKFLOWS

### 3.1 Starting a New Development Session

1. **Read current status**: Check `ICE_DEVELOPMENT_TODO.md` for current sprint tasks
2. **Review recent changes**: Check `PROJECT_CHANGELOG.md` for latest updates
3. **Understand context**: Read relevant section in `ICE_PRD.md` for requirements
4. **Check file locations**: Use `PROJECT_STRUCTURE.md` to navigate codebase
5. **Set environment**: `export OPENAI_API_KEY="sk-..."` and any other required API keys

### 3.2 Common Development Tasks

**Adding New Data Sources** - See `CLAUDE_PATTERNS.md` Pattern 1-2 for source attribution and confidence scoring

**Modifying Orchestration** - Delegate to production modules (see `CLAUDE_PATTERNS.md` for code organization principles)

**Notebook Development**:
- Core data ingestion changes â†’ Update `ice_building_workflow.ipynb`
- Query processing modifications â†’ Update `ice_query_workflow.ipynb`
- **Process**: Modify production code first â†’ Update notebook cells â†’ Run end-to-end validation

> **ðŸ“– For notebook features (visualization, confidence filtering, consolidated control)**: See previous CLAUDE.md Section 3.3 (in backup)

### 3.3 TodoWrite Mandatory Practice âš ï¸

**CRITICAL**: Every TodoWrite list MUST include these two todos as the FINAL items:

```
[ ] ðŸ“‹ Review & update 8 core files + 2 notebooks if changes warrant synchronization
    - Core files: ARCHITECTURE.md, PROGRESS.md, PROJECT_STRUCTURE.md, CLAUDE.md, README.md, PROJECT_CHANGELOG.md, ICE_DEVELOPMENT_TODO.md, ICE_PRD.md
    - ARCHITECTURE.md: Update only on architecture changes (stable north star)
    - PROGRESS.md: ALWAYS update with session state (active work, blockers, next 3-5 actions)
    - Other 6 files: Update only on milestones
    - Notebooks: ice_building_workflow.ipynb, ice_query_workflow.ipynb
    - Skip only if: bug fixes, minor code changes, temporary/test files

[ ] ðŸ§  Update Serena server memory if work warrants documentation
    - Use mcp__serena__write_memory for: architecture decisions, implementation patterns, debugging solutions
    - Memory names: Use descriptive names (e.g., 'week6_testing_patterns', 'email_integration_debugging')
    - Document: Key decisions, file locations, workflows, solutions to complex problems
    - Skip only if: Minor bug fixes, temporary code, work-in-progress, trivial changes
```

**Why**: Prevents documentation drift and preserves institutional knowledge across Claude Code sessions.

### 3.4 Testing and Validation

**Three-tier approach**:
1. **Unit Tests**: `python tests/test_email_graph_integration.py`
2. **Integration Tests**: Run both notebooks end-to-end
3. **PIVF Validation**: 20 golden queries covering 1-3 hop reasoning (see `ICE_VALIDATION_FRAMEWORK.md`)

### 3.5 Debugging Workflows

**First Steps**:
1. Check system health: `python check/health_checks.py`
2. Review logs: `logs/session_start.json`, `logs/pre_tool_use.json`
3. Validate data sources: `sandbox/python_notebook/ice_data_sources_demo_simple.ipynb`

> **ðŸ“– For complete troubleshooting guide**: See `CLAUDE_TROUBLESHOOTING.md`

---

## 4. ðŸ“ DEVELOPMENT STANDARDS

### 4.1 File Header Requirements

**Every file must start with these 4 comment lines**:
```python
# Location: /path/to/file.py
# Purpose: Clear description of what this file does
# Why: Business purpose and role in ICE architecture
# Relevant Files: file1.py, file2.py, file3.py
```

### 4.2 Comment Principles

```python
# DON'T: Obvious syntax comments
x = x + 1  # Increment x

# DO: Explain thought process and business logic
# Confidence threshold set to 0.7 based on PIVF validation showing
# accuracy >95% at this level while minimizing false positives
confidence_threshold = 0.7
```

**NEVER delete explanatory comments** unless demonstrably wrong or obsolete.

### 4.3 ICE-Specific Patterns

**All 7 patterns with comprehensive examples**: See `CLAUDE_PATTERNS.md`
1. Source Attribution - Every fact must trace to source
2. Confidence Scoring - All entities/relationships include confidence
3. Multi-hop Reasoning - Support 1-3 hop graph traversal
4. MCP Compatibility - Format outputs as structured JSON
5. SOURCE Markers - Document source attribution for statistics tracking
6. Crawl4AI Hybrid URL Fetching - Smart routing for web scraping (6-tier classification)
7. Two-Layer Entity Extraction - Validated entities with quality scores

> **ðŸ“– For code examples and testing patterns**: See `CLAUDE_PATTERNS.md`

### 4.4 Code Organization Principles

1. **Modularity**: Build lightweight, maintainable components
2. **Simplicity**: Favor straightforward solutions over complex architectures
3. **Reusability**: Import from production modules, don't duplicate code
4. **Traceability**: Every fact must have source attribution
5. **Security**: Never expose API keys or credentials in code/commits

### 4.5 Protected Files - NEVER Delete or Move

- `CLAUDE.md` (this file)
- `README.md`
- `ICE_PRD.md`
- `ICE_DEVELOPMENT_TODO.md`
- `PROJECT_STRUCTURE.md`
- `PROJECT_CHANGELOG.md`
- `ice_building_workflow.ipynb`
- `ice_query_workflow.ipynb`

**Before modifying**: Create timestamped backup in `archive/backups/`

---

## 5. ðŸ—‚ï¸ NAVIGATION QUICK LINKS

**Core Documentation**: `ICE_PRD.md` (requirements), `ICE_DEVELOPMENT_TODO.md` (tasks), `PROJECT_STRUCTURE.md` (file locations), `ICE_ARCHITECTURE_IMPLEMENTATION_PLAN.md` (architecture), `ICE_VALIDATION_FRAMEWORK.md` (testing), `PROJECT_CHANGELOG.md` (changes)

**Query Modes**: See `md_files/QUERY_PATTERNS.md:10-100` for complete guide
- **local**: Entity lookup | **global**: Summaries | **hybrid**: Investment analysis (recommended)
- **mix**: Multi-aspect queries | **naive**: Semantic search

**Data Source Prioritization**: Real-time signals (API/MCP â†’ Email â†’ SEC), Deep research (Email â†’ SEC â†’ API/MCP), Regulatory compliance (SEC â†’ Email â†’ API/MCP)

**Development Strategies**:
- **Skip Graph Building**: `REBUILD_GRAPH = False` (instant, use existing graph)
- **Tiered Portfolio**: `tiny` (10 min), `small` (25 min), `medium` (48 min), `full` (102 min)

---

## 6. ðŸ”§ TROUBLESHOOTING

**Top 3 Common Issues**:
1. **API Key Not Found**: `export OPENAI_API_KEY="sk-..." && python test_api_key.py`
2. **LightRAG Import Error**: `cd src/ice_lightrag && python setup.py && cd ../..`
3. **Module Import Failures**: `export PYTHONPATH="${PYTHONPATH}:."`

> **ðŸ“– For comprehensive troubleshooting (10 sections, 50+ issues)**: See `CLAUDE_TROUBLESHOOTING.md`

---

## 7. ðŸ“š RESOURCES

**Technical Guides**: [LightRAG Setup](md_files/LIGHTRAG_SETUP.md), [Local LLM Guide](md_files/LOCAL_LLM_GUIDE.md), [Query Patterns](md_files/QUERY_PATTERNS.md)

**Architecture**: [UDMA Implementation Plan](ICE_ARCHITECTURE_IMPLEMENTATION_PLAN.md), [Architecture Decision History](archive/strategic_analysis/README.md), [Validation Framework](ICE_VALIDATION_FRAMEWORK.md)

**Workflows**: [Building Workflow](project_information/about_lightrag/lightrag_building_workflow.md), [Query Workflow](project_information/about_lightrag/lightrag_query_workflow.md)

**Key Serena Memories**: `imap_integration_reference`, `troubleshooting_comprehensive_guide_2025_10_18`, `email_ingestion_trust_the_graph_strategy_2025_10_17`

---

## 8. ðŸ“„ SPECIALIZED DOCUMENTATION (When to Load)

### CLAUDE_PATTERNS.md (~400 lines)
**Load when**: Implementing features, writing code, debugging patterns
**Contains**:
- All 7 ICE coding patterns with comprehensive examples
- Pattern 1-5: Source Attribution, Confidence Scoring, Multi-hop Reasoning, MCP Compatibility, SOURCE Markers
- Pattern 6-7: Crawl4AI Hybrid URL Fetching, Two-Layer Entity Extraction + Confidence Filtering
- Code organization principles, testing patterns, when-to-use guidance
- Example code snippets for each pattern

### CLAUDE_INTEGRATIONS.md (~450 lines)
**Load when**: Working on Docling integration, Crawl4AI URL fetching, document processing
**Contains**:
- **Docling Integration**: Switchable architecture (toggle via env vars)
  - 3 patterns: EXTENSION (SEC filings), REPLACEMENT (email attachments), NEW FEATURE (URL PDFs)
  - Configuration: `USE_DOCLING_SEC`, `USE_DOCLING_EMAIL`, `USE_DOCLING_URLS`
  - Table extraction accuracy: 42% â†’ 97.9%
- **Crawl4AI Integration**: 6-tier URL classification system
  - Configuration: `USE_CRAWL4AI_LINKS`, `CRAWL4AI_TIMEOUT`, `URL_RATE_LIMIT_DELAY`, `URL_CONCURRENT_DOWNLOADS`
  - Tier 1-2: Simple HTTP (always enabled)
  - Tier 3-5: Crawl4AI (requires enablement)
  - Tier 6: Skip (social media, tracking)
- Troubleshooting for both integrations

### CLAUDE_TROUBLESHOOTING.md (~350 lines)
**Load when**: Debugging errors, performance issues, data quality problems
**Contains**:
- Quick debugging workflow (6 steps for 90% of issues)
- Quick reference table for common issues
- 10 sections: Environment setup, integration errors, performance issues, data quality, notebook issues, Docling-specific, Crawl4AI-specific, debugging commands, advanced debugging, nuclear options
- 50+ issue-solution pairs with validation commands
- Top 5 common issues with immediate fixes

---

**Last Updated**: 2025-11-05
**Backup**: `archive/backups/CLAUDE_20251105_pre_streamlining.md`
**Refinement**: Reduced from 657 lines to 280 lines (57% reduction) with zero information loss
**Maintenance**: Update this file when major workflows, architecture, or standards change
