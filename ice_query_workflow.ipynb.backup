{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 0\n",
    "\n",
    "# ICE Query Workflow - Investment Intelligence Analysis\n",
    "\n",
    "**Purpose**: Interactive financial analysis and investment intelligence using LightRAG knowledge graph\n",
    "**Prerequisites**: Complete knowledge graph built via `ice_building_workflow.ipynb`\n",
    "**Architecture**: ICE Simplified with 6 LightRAG query modes\n",
    "\n",
    "## Query Workflow Overview\n",
    "\n",
    "1. **System Connection** - Connect to built knowledge graph\n",
    "2. **Portfolio Analysis** - Automated risk and opportunity assessment\n",
    "3. **Query Mode Testing** - Explore all 6 LightRAG query modes\n",
    "4. **Investment Intelligence** - Natural language financial queries\n",
    "5. **Performance Monitoring** - Query metrics and optimization\n",
    "6. **Results Export** - Save analysis and insights\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 1\n",
    "\n",
    "## 1. System Connection & Readiness Check"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udd0d ICE Query Workflow\n",
      "\ud83d\udcc5 2025-11-08 17:00\n",
      "\ud83d\udcc1 Working Directory: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 2: Setup and imports\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "import sys\n",
    "import os\n",
    "from pathlib import Path\n",
    "from datetime import datetime\n",
    "import json\n",
    "\n",
    "# Add project root to path\n",
    "project_root = Path.cwd()\n",
    "sys.path.insert(0, str(project_root))\n",
    "\n",
    "print(f\"\ud83d\udd0d ICE Query Workflow\")\n",
    "print(f\"\ud83d\udcc5 {datetime.now().strftime('%Y-%m-%d %H:%M')}\")\n",
    "print(f\"\ud83d\udcc1 Working Directory: {project_root}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:ice_data_ingestion.ice_integration:ICE LightRAG system initialized successfully\n",
      "INFO:ice_data_ingestion.ice_integration:ICE LightRAG system initialized successfully\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 LightRAG successfully imported!\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:updated_architectures.implementation.ice_simplified:ICE Core initializing with ICESystemManager orchestration\n",
      "INFO:src.ice_core.ice_system_manager:ICE System Manager initialized with working_dir: ice_lightrag/storage\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 ICESystemManager initialized successfully\n",
      "INFO:imap_email_ingestion_pipeline.entity_extractor:spaCy model loaded successfully\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 TickerValidator initialized (false positive filtering)\n",
      "INFO:src.ice_docling.docling_processor:DoclingProcessor initialized: storage=/Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 DoclingProcessor initialized (97.9% table accuracy)\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 BenzingaClient initialized (real-time professional news)\n",
      "INFO:src.ice_docling.docling_processor:DoclingProcessor initialized: storage=/Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:imap_email_ingestion_pipeline.intelligent_link_processor.IntelligentLinkProcessor:Intelligent Link Processor initialized. Storage path: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:imap_email_ingestion_pipeline.intelligent_link_processor.IntelligentLinkProcessor:Rate limiting: 1.0s delay, max 3 concurrent downloads\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 IntelligentLinkProcessor initialized (hybrid URL fetching) with Docling (97.9% table accuracy)\n",
      "INFO:updated_architectures.implementation.data_ingestion:\ud83d\uddc2\ufe0f  STORAGE PATH RESOLUTION:\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Current file: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/updated_architectures/implementation/data_ingestion.py\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Resolved path: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Path exists: True\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Path writable: True\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 Unified storage path confirmed: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:updated_architectures.implementation.data_ingestion:Data Ingester initialized with 7 API services: ['newsapi', 'alpha_vantage', 'fmp', 'polygon', 'finnhub', 'benzinga', 'marketaux']\n",
      "INFO:updated_architectures.implementation.data_ingestion:Production modules initialized: SEC EDGAR connector, EntityExtractor, GraphBuilder, AttachmentProcessor, IntelligentLinkProcessor ready\n",
      "INFO:updated_architectures.implementation.signal_store:Signal Store tables created successfully\n",
      "INFO:updated_architectures.implementation.signal_store:Signal Store initialized at data/signal_store/signal_store.db\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 Signal Store initialized for dual-layer architecture\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query Engine initialized\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 Query router initialized for dual-layer architecture\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 ICE Simplified system initialized successfully\n",
      "INFO:src.ice_core.ice_system_manager:LightRAG wrapper created successfully (lazy initialization mode)\n",
      "INFO:src.ice_core.ice_system_manager:Exa MCP connector initialized successfully\n",
      "INFO:src.ice_core.ice_graph_builder:ICE Graph Builder initialized\n",
      "INFO:src.ice_core.ice_graph_builder:LightRAG instance updated in Graph Builder\n",
      "INFO:src.ice_core.ice_system_manager:Graph Builder initialized successfully\n",
      "INFO:src.ice_core.ice_query_processor:ICE Query Processor initialized\n",
      "INFO:src.ice_core.ice_system_manager:Query Processor initialized successfully\n",
      "INFO:updated_architectures.implementation.ice_simplified:System health: ready=True\n",
      "INFO:updated_architectures.implementation.ice_simplified:Components: {'lightrag': True, 'exa_connector': True, 'graph_builder': True, 'query_processor': True, 'data_manager': False}\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 ICE system created and ready for operations\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 ICE System Connected\n",
      "\ud83e\udde0 LightRAG Status: Ready\n",
      "\ud83d\udcca Architecture: ICE Simplified (2,508 lines)\n",
      "\ud83d\udd78\ufe0f Knowledge Graph: Ready\n",
      "\ud83d\udcbe Graph Size: 2.91 MB\n",
      "\ud83d\udce6 Components Ready: 4/4\n",
      "\ud83d\udce7 Investment Signals: EntityExtractor integrated (BUY/SELL ratings, confidence scores)\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 3: Connect to ICE system and verify knowledge graph\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "from updated_architectures.implementation.ice_simplified import create_ice_system\n",
    "\n",
    "try:\n",
    "    ice = create_ice_system()\n",
    "    system_ready = ice.is_ready()\n",
    "    print(f\"\u2705 ICE System Connected\")\n",
    "    print(f\"\ud83e\udde0 LightRAG Status: {'Ready' if system_ready else 'Initializing'}\")\n",
    "    print(f\"\ud83d\udcca Architecture: ICE Simplified (2,508 lines)\")\n",
    "    \n",
    "    if system_ready:\n",
    "        # Check if knowledge graph has been built\n",
    "        storage_stats = ice.core.get_storage_stats()\n",
    "        graph_ready = storage_stats['total_storage_bytes'] > 0\n",
    "        print(f\"\ud83d\udd78\ufe0f Knowledge Graph: {'Ready' if graph_ready else 'Not built - run ice_building_workflow.ipynb first'}\")\n",
    "        \n",
    "        if graph_ready:\n",
    "            print(f\"\ud83d\udcbe Graph Size: {storage_stats['total_storage_bytes'] / (1024 * 1024):.2f} MB\")\n",
    "            components_ready = sum(1 for c in storage_stats['components'].values() if c['exists'])\n",
    "            print(f\"\ud83d\udce6 Components Ready: {components_ready}/4\")\n",
    "            \n",
    "            # Phase 2.6.1: Investment signal extraction enabled\n",
    "            print(f\"\ud83d\udce7 Investment Signals: EntityExtractor integrated (BUY/SELL ratings, confidence scores)\")\n",
    "        else:\n",
    "            raise RuntimeError(\"No knowledge graph found. Please run ice_building_workflow.ipynb first.\")\n",
    "    \n",
    "except Exception as e:\n",
    "    print(f\"\u274c Connection Error: {e}\")\n",
    "    raise  # Let errors surface for proper debugging"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udcc4 Loaded from: portfolio_holdings.csv (5 holdings)\n",
      "\ud83c\udfaf Portfolio Configuration\n",
      "\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n",
      "Holdings: NVDA, TSMC, AMD, ASML, FICO\n",
      "Analysis Mode: Investment Intelligence Queries\n",
      "\n",
      "\ud83d\udd0d Available Query Modes: 6\n",
      "  \u2705 naive\n",
      "  \u2705 local\n",
      "  \u2705 global\n",
      "  \u2705 hybrid\n",
      "  \u2705 mix\n",
      "  \u2705 bypass\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 4: Portfolio configuration - load from CSV\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "import pandas as pd\n",
    "\n",
    "try:\n",
    "    portfolio_df = pd.read_csv('portfolio_holdings.csv')\n",
    "    # Basic validation\n",
    "    if portfolio_df.empty:\n",
    "        raise ValueError(\"Portfolio CSV is empty\")\n",
    "    if 'ticker' not in portfolio_df.columns:\n",
    "        raise ValueError(\"CSV must have 'ticker' column\")\n",
    "    holdings = portfolio_df['ticker'].tolist()\n",
    "    print(f\"\ud83d\udcc4 Loaded from: portfolio_holdings.csv ({len(holdings)} holdings)\")\n",
    "except FileNotFoundError:\n",
    "    print(\"\u26a0\ufe0f portfolio_holdings.csv not found - using defaults\")\n",
    "    holdings = ['NVDA', 'TSMC', 'AMD', 'ASML']\n",
    "\n",
    "print(f\"\ud83c\udfaf Portfolio Configuration\")\n",
    "print(f\"\u2501\" * 40)\n",
    "print(f\"Holdings: {', '.join(holdings)}\")\n",
    "print(f\"Analysis Mode: Investment Intelligence Queries\")\n",
    "\n",
    "# Verify query modes available\n",
    "if not (ice and ice.core.is_ready()):\n",
    "    raise RuntimeError(\"ICE system not available for queries\")\n",
    "\n",
    "available_modes = ice.core.get_query_modes()\n",
    "print(f\"\\n\ud83d\udd0d Available Query Modes: {len(available_modes)}\")\n",
    "for mode in available_modes:\n",
    "    print(f\"  \u2705 {mode}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 5\n",
    "\n",
    "### \ud83d\udd27 Model Provider Configuration\n",
    "\n",
    "ICE supports **OpenAI** (paid) or **Ollama** (free local) for LLM and embeddings:\n",
    "\n",
    "#### Option 1: OpenAI (Default - No setup required)\n",
    "```bash\n",
    "export OPENAI_API_KEY=\"sk-...\"\n",
    "```\n",
    "- **Cost**: ~$5/month for typical usage\n",
    "- **Quality**: Highest accuracy for entity extraction and reasoning\n",
    "- **Setup**: Just set API key\n",
    "\n",
    "#### Option 2: Ollama (Free Local - Requires setup)\n",
    "```bash\n",
    "# Set provider\n",
    "export LLM_PROVIDER=\"ollama\"\n",
    "\n",
    "# One-time setup:\n",
    "ollama serve                          # Start Ollama service\n",
    "ollama pull llama3.1:8b               # Faster model (4.7GB, used in this notebook)\n",
    "# OR\n",
    "ollama pull qwen3:30b-32k            # More accurate model (18.5GB, 32k context)\n",
    "ollama pull nomic-embed-text          # Pull embedding model\n",
    "```\n",
    "\n",
    "**Model Selection**:\n",
    "- **llama3.1:8b** (4.7GB) - Faster, recommended for development and testing (used in Cell 8)\n",
    "- **qwen3:30b-32k** (18.5GB) - Better accuracy, 32k context for complex financial analysis\n",
    "\n",
    "**Note**: This notebook uses `llama3.1:8b` for faster iterations. To switch to `qwen3:30b-32k`, update Cell 8.\n",
    "\n",
    "- **Cost**: $0/month (completely free)\n",
    "- **Quality**: Good-to-excellent for investment analysis (model-dependent)\n",
    "- **Setup**: Requires local Ollama installation and model download\n",
    "\n",
    "#### Option 3: Hybrid (Recommended for cost-conscious users)\n",
    "```bash\n",
    "export LLM_PROVIDER=\"ollama\"           # Use Ollama for LLM\n",
    "export EMBEDDING_PROVIDER=\"openai\"     # Use OpenAI for embeddings\n",
    "export OPENAI_API_KEY=\"sk-...\"\n",
    "```\n",
    "- **Cost**: ~$2/month (embeddings only)\n",
    "- **Quality**: Balanced - free LLM with high-quality embeddings\n",
    "\n",
    "**Current configuration will be logged when you connect to ICE system.**"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 6\n",
    "\n",
    "### \ud83d\udcc4 Docling Document Processing (Switchable Architecture)\n",
    "\n",
    "ICE supports **switchable document processing** for SEC filings and email attachments:\n",
    "\n",
    "#### Docling Integration (Default - Professional-grade table extraction)\n",
    "```bash\n",
    "export USE_DOCLING_SEC=true          # SEC filings: 0% \u2192 97.9% table extraction\n",
    "export USE_DOCLING_EMAIL=true        # Email attachments: 42% \u2192 97.9% accuracy\n",
    "```\n",
    "- **Accuracy**: 97.9% table extraction (vs 42% with PyPDF2)\n",
    "- **Cost**: $0/month (local execution)\n",
    "- **Setup**: Models auto-download on first use (~500MB, one-time)\n",
    "\n",
    "#### Original Implementations (For comparison testing)\n",
    "```bash\n",
    "export USE_DOCLING_SEC=false         # Use metadata-only SEC extraction\n",
    "export USE_DOCLING_EMAIL=false       # Use PyPDF2/openpyxl processors\n",
    "```\n",
    "- **Purpose**: A/B testing and backward compatibility\n",
    "- **Use when**: Comparing extraction accuracy or troubleshooting\n",
    "\n",
    "**Note**: Docling uses IBM's AI models (DocLayNet, TableFormer, Granite-Docling VLM) for professional-grade document parsing. Both implementations coexist - toggle switches instantly without code changes.\n",
    "\n",
    "**More info**: See `md_files/DOCLING_INTEGRATION_TESTING.md` for detailed testing procedures."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 7\n",
    "\n",
    "### \ud83c\udf10 Crawl4AI URL Fetching (Reference)\n",
    "\n",
    "The knowledge graph you're querying was built using ICE's hybrid URL fetching strategy:\n",
    "\n",
    "- **Default**: Simple HTTP (fast, free) for DBS research URLs, direct PDFs, SEC EDGAR\n",
    "- **Optional**: Crawl4AI browser automation for complex sites (premium portals, JS-heavy IR sites)\n",
    "\n",
    "**Configuration** (used during graph building in `ice_building_workflow.ipynb`):\n",
    "```bash\n",
    "export USE_CRAWL4AI_LINKS=false      # Default: Simple HTTP only\n",
    "export USE_CRAWL4AI_LINKS=true       # Enable hybrid routing with Crawl4AI\n",
    "```\n",
    "\n",
    "This query workflow uses the **existing graph** - URL fetching only happens during graph building.\n",
    "\n",
    "**More info**: See `ice_building_workflow.ipynb` Cell 9 for detailed configuration options."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 Switched to Full Ollama (llama3.1:8b - faster)\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 8: Provider switching - Uncomment ONE option, then restart kernel\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "# ### Option 1: OpenAI ($5/mo, highest quality)\n",
    "# import os; os.environ['LLM_PROVIDER'] = 'openai' \n",
    "# print(\"\u2705 Switched to OpenAI\")\n",
    "\n",
    "# ###Option 2: Hybrid ($2/mo, 60% savings, recommended)\n",
    "# import os; os.environ['LLM_PROVIDER'] = 'ollama'; os.environ['EMBEDDING_PROVIDER'] = 'openai'\n",
    "# print(\"\u2705 Switched to Hybrid\")\n",
    "\n",
    "### Option 3: Full Ollama ($0/mo, faster iterations)\n",
    "# Using llama3.1:8b (4.7GB) for development speed instead of qwen3:30b-32k (18.5GB)\n",
    "# To use qwen3 for better accuracy: os.environ['LLM_MODEL'] = 'qwen3:30b-32k'\n",
    "import os; os.environ['LLM_PROVIDER'] = 'ollama'; os.environ['EMBEDDING_PROVIDER'] = 'ollama'\n",
    "os.environ['LLM_MODEL'] = 'llama3.1:8b'; print(\"\u2705 Switched to Full Ollama (llama3.1:8b - faster)\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udd27 Active LLM Configuration:\n",
      "  LLM Provider: ollama\n",
      "  LLM Model: llama3.1:8b\n",
      "  Embedding Provider: ollama\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 9: Check active LLM provider configuration\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "provider = os.getenv('LLM_PROVIDER', 'openai')\n",
    "model = os.getenv('LLM_MODEL', 'gpt-4o-mini' if provider == 'openai' else 'qwen3:30b-32k')\n",
    "embedding = os.getenv('EMBEDDING_PROVIDER', provider)\n",
    "\n",
    "print(\"\ud83d\udd27 Active LLM Configuration:\")\n",
    "print(f\"  LLM Provider: {provider}\")\n",
    "print(f\"  LLM Model: {model}\")\n",
    "print(f\"  Embedding Provider: {embedding}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:updated_architectures.implementation.ice_simplified:ICE Core initializing with ICESystemManager orchestration\n",
      "INFO:src.ice_core.ice_system_manager:ICE System Manager initialized with working_dir: ice_lightrag/storage\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 ICESystemManager initialized successfully\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udd04 Reinitializing ICE system with new configuration...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:imap_email_ingestion_pipeline.entity_extractor:spaCy model loaded successfully\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 TickerValidator initialized (false positive filtering)\n",
      "INFO:src.ice_docling.docling_processor:DoclingProcessor initialized: storage=/Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 DoclingProcessor initialized (97.9% table accuracy)\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 BenzingaClient initialized (real-time professional news)\n",
      "INFO:src.ice_docling.docling_processor:DoclingProcessor initialized: storage=/Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:imap_email_ingestion_pipeline.intelligent_link_processor.IntelligentLinkProcessor:Intelligent Link Processor initialized. Storage path: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:imap_email_ingestion_pipeline.intelligent_link_processor.IntelligentLinkProcessor:Rate limiting: 1.0s delay, max 3 concurrent downloads\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 IntelligentLinkProcessor initialized (hybrid URL fetching) with Docling (97.9% table accuracy)\n",
      "INFO:updated_architectures.implementation.data_ingestion:\ud83d\uddc2\ufe0f  STORAGE PATH RESOLUTION:\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Current file: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/updated_architectures/implementation/data_ingestion.py\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Resolved path: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Path exists: True\n",
      "INFO:updated_architectures.implementation.data_ingestion:   Path writable: True\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 Unified storage path confirmed: /Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/data/attachments\n",
      "INFO:updated_architectures.implementation.data_ingestion:Data Ingester initialized with 7 API services: ['newsapi', 'alpha_vantage', 'fmp', 'polygon', 'finnhub', 'benzinga', 'marketaux']\n",
      "INFO:updated_architectures.implementation.data_ingestion:Production modules initialized: SEC EDGAR connector, EntityExtractor, GraphBuilder, AttachmentProcessor, IntelligentLinkProcessor ready\n",
      "INFO:updated_architectures.implementation.signal_store:Signal Store tables created successfully\n",
      "INFO:updated_architectures.implementation.signal_store:Signal Store initialized at data/signal_store/signal_store.db\n",
      "INFO:updated_architectures.implementation.data_ingestion:\u2705 Signal Store initialized for dual-layer architecture\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query Engine initialized\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 Query router initialized for dual-layer architecture\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 ICE Simplified system initialized successfully\n",
      "INFO:src.ice_core.ice_system_manager:LightRAG wrapper created successfully (lazy initialization mode)\n",
      "INFO:src.ice_core.ice_system_manager:Exa MCP connector initialized successfully\n",
      "INFO:src.ice_core.ice_graph_builder:ICE Graph Builder initialized\n",
      "INFO:src.ice_core.ice_graph_builder:LightRAG instance updated in Graph Builder\n",
      "INFO:src.ice_core.ice_system_manager:Graph Builder initialized successfully\n",
      "INFO:src.ice_core.ice_query_processor:ICE Query Processor initialized\n",
      "INFO:src.ice_core.ice_system_manager:Query Processor initialized successfully\n",
      "INFO:updated_architectures.implementation.ice_simplified:System health: ready=True\n",
      "INFO:updated_architectures.implementation.ice_simplified:Components: {'lightrag': True, 'exa_connector': True, 'graph_builder': True, 'query_processor': True, 'data_manager': False}\n",
      "INFO:updated_architectures.implementation.ice_simplified:\u2705 ICE system created and ready for operations\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 System reinitialized successfully\n",
      "   LightRAG Status: Ready\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 10: Reinitialize ICE system with updated provider configuration\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"\ud83d\udd04 Reinitializing ICE system with new configuration...\")\n",
    "from updated_architectures.implementation.ice_simplified import create_ice_system\n",
    "ice = create_ice_system()\n",
    "print(\"\u2705 System reinitialized successfully\")\n",
    "print(f\"   LightRAG Status: {'Ready' if ice.is_ready() else 'Initializing'}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 11\n",
    "\n",
    "## 2. Portfolio Risk & Opportunity Analysis"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing portfolio risks...\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing risks for NVDA\n",
      "WARNING:src.ice_lightrag.model_provider:Ollama model 'llama3.1:8b' not available\n",
      "WARNING:src.ice_lightrag.model_provider:\u26a0\ufe0f  Falling back to OpenAI: Model not found. Pull with: ollama pull llama3.1:8b\n",
      "INFO:src.ice_lightrag.model_provider:\u2705 Using OpenAI provider (fallback from Ollama) with temperature=0.0\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\ud83c\udfaf Automated Portfolio Analysis\n",
      "\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: [_] Loaded graph from ice_lightrag/storage/graph_chunk_entity_relation.graphml with 80 nodes, 77 edges\n",
      "INFO:nano-vectordb:Load (80, 1536) data\n",
      "INFO:nano-vectordb:Init {'embedding_dim': 1536, 'metric': 'cosine', 'storage_file': 'ice_lightrag/storage/vdb_entities.json'} 80 data\n",
      "INFO:nano-vectordb:Load (77, 1536) data\n",
      "INFO:nano-vectordb:Init {'embedding_dim': 1536, 'metric': 'cosine', 'storage_file': 'ice_lightrag/storage/vdb_relationships.json'} 77 data\n",
      "INFO:nano-vectordb:Load (12, 1536) data\n",
      "INFO:nano-vectordb:Init {'embedding_dim': 1536, 'metric': 'cosine', 'storage_file': 'ice_lightrag/storage/vdb_chunks.json'} 12 data\n",
      "INFO: [_] Process 47263 KV load full_docs with 1 records\n",
      "INFO: [_] Process 47263 KV load text_chunks with 12 records\n",
      "INFO: [_] Process 47263 KV load full_entities with 1 records\n",
      "INFO: [_] Process 47263 KV load full_relations with 1 records\n",
      "INFO: [_] Process 47263 KV load entity_chunks with 80 records\n",
      "INFO: [_] Process 47263 KV load relation_chunks with 77 records\n",
      "INFO: [_] Process 47263 KV load llm_response_cache with 30 records\n",
      "INFO: [_] Process 47263 doc status load doc_status with 1 records\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:\u2705 Pipeline status initialized successfully\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:\u2705 JupyterICERAG initialized successfully\n",
      "INFO: LLM func: 4 new workers initialized (Timeouts: Func: 180s, Worker: 360s, Health Check: 375s)\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:da410ddb8ee5db1cf1ed30757e03c5d4\n",
      "INFO: Query nodes: NVDA, NVIDIA, Supply chain, Regulations, Competition, Financial stability (top_k:40, cosine:0.2)\n",
      "INFO: Embedding func: 8 new workers initialized (Timeouts: Func: 30s, Worker: 60s, Health Check: 75s)\n",
      "INFO: Local query: 40 entites, 65 relations\n",
      "INFO: Query edges: Business risks, Market risks, Supply chain risks, Regulatory risks, Competitive risks, Financial risks (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 39 entites, 40 relations\n",
      "INFO: Raw search results: 53 entities, 69 relations, 0 vector chunks\n",
      "INFO: After truncation: 53 entities, 69 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 69 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 53 entities, 69 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E8/3 E8/4 E12/5 E7/6 E3/7 E6/8 E6/9 E7/10 E8/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:d7839fd668efb45fa28f5118a96b8ffb\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 53 entities, 69 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 124 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing risks for TSMC\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:00d428a51c39cce347682be93c1524a9\n",
      "INFO: Query nodes: TSMC, Supply chain, Regulations, Competition, Financial stability, Market analysis (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 65 relations\n",
      "INFO: Query edges: Business risks, Market risks, TSMC, Supply chain risks, Regulatory risks, Competitive risks, Financial risks (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 43 entites, 40 relations\n",
      "INFO: Raw search results: 53 entities, 70 relations, 0 vector chunks\n",
      "INFO: After truncation: 53 entities, 70 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 70 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 53 entities, 70 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E9/2 E8/3 E6/4 E5/5 E6/6 E10/7 E7/8 E12/9 E4/10 E8/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:8cc1ef1dbb398445e1be9749b77ed074\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 53 entities, 70 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 124 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing risks for AMD\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:88e3e6a500f122c679caeb72273c8d01\n",
      "INFO: Query nodes: Advanced Micro Devices, Supply chain, Regulations, Competition, Financial stability, Market analysis (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 72 relations\n",
      "INFO: Query edges: Business risks, Market risks, AMD, Supply chain risks, Regulatory risks, Competitive risks, Financial risks (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 51 entities, 73 relations, 0 vector chunks\n",
      "INFO: After truncation: 51 entities, 73 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 73 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 51 entities, 73 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E5/2 E9/3 E9/4 E12/5 E9/6 E8/7 E6/8 E5/9 E4/10 E3/11 E6/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:9ff1a256abe7bd63a412306f7a32a951\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 51 entities, 73 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 123 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing risks for ASML\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:9010a67c25754864451c73073f2e0246\n",
      "INFO: Query nodes: Supply chain, Regulations, Competition, Financial stability, Market analysis (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 71 relations\n",
      "INFO: Query edges: Business risks, Market risks, ASML, Supply chain risks, Regulatory risks, Competitive risks, Financial risks (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 38 entites, 40 relations\n",
      "INFO: Raw search results: 50 entities, 72 relations, 0 vector chunks\n",
      "INFO: After truncation: 50 entities, 72 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 72 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 50 entities, 72 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E7/3 E8/4 E13/5 E8/6 E6/7 E5/8 E5/9 E5/10 E7/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:d287e048ef9399b5fabceb61f6e8054e\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 50 entities, 72 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 124 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing risks for FICO\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:7538b7747f938b287b85feb05aeeb1c0\n",
      "INFO: Query nodes: Supply chain, Regulations, Competition, Financial stability, Risk management (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 34 entites, 65 relations\n",
      "INFO: Query edges: Business risks, Market risks, FICO, Supply chain risks, Regulatory risks, Competitive risks, Financial risks (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 41 entites, 40 relations\n",
      "INFO: Raw search results: 49 entities, 68 relations, 0 vector chunks\n",
      "INFO: After truncation: 49 entities, 68 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 68 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 49 entities, 68 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E9/3 E7/4 E11/5 E8/6 E5/7 E5/8 E3/9 E8/10 E3/11 E5/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:e6b6f5e45ad96ff40567183f2f4968cc\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 49 entities, 68 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 124 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Portfolio risk analysis completed for 5 holdings\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing portfolio opportunities...\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing opportunities for NVDA\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:c6dc39768b6ef195d17fe573cfdfe3b5\n",
      "INFO: Query nodes: NVDA, NVIDIA, Semiconductor industry, Artificial intelligence, Cloud computing, Gaming market (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 63 relations\n",
      "INFO: Query edges: Growth opportunities, Market advantages, Technology trends, Market expansion, Competitive positioning (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 53 entities, 66 relations, 0 vector chunks\n",
      "INFO: After truncation: 53 entities, 66 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 66 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 53 entities, 66 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E8/1 E6/2 E8/3 E9/4 E11/5 E9/6 E3/7 E8/8 E3/9 E10/10 E3/11 E7/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:ad0f09bc61b9a06ed94b2adf688fdfa3\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 53 entities, 66 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 144 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing opportunities for TSMC\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:1e667ff6d81b6ded9ba6d8b490c540a3\n",
      "INFO: Query nodes: TSMC, Semiconductor industry, Innovation, Supply chain, Market share (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 64 relations\n",
      "INFO: Query edges: Growth opportunities, Market advantages, Technology trends, Market expansion, Competitive positioning (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 53 entities, 65 relations, 0 vector chunks\n",
      "INFO: After truncation: 53 entities, 65 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 65 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 53 entities, 65 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E11/2 E9/3 E10/4 E8/5 E5/6 E10/7 E2/8 E3/9 E8/10 E8/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:046796d01b35e8b48ccd8737e57708fa\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 53 entities, 65 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 144 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing opportunities for AMD\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:54f7cd7697934aca1b4425f4932fdd68\n",
      "INFO: Query nodes: AMD, Semiconductors, Market share, Innovation, Product development (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 38 entites, 63 relations\n",
      "INFO: Query edges: Growth opportunities, Market advantages, Technology trends, Market expansion, Competitive positioning (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 52 entities, 64 relations, 0 vector chunks\n",
      "INFO: After truncation: 52 entities, 64 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 64 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 52 entities, 64 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E5/1 E8/2 E11/3 E8/4 E9/5 E8/6 E7/7 E11/8 E2/9 E3/10 E3/11 E9/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:f1473e616aa57e55f52fc6e1b0540bdc\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 52 entities, 64 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 143 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing opportunities for ASML\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:50448f87edc61a5bb0e529b93b64fc89\n",
      "INFO: Query nodes: ASML, Semiconductor industry, Innovation, Market share, R&D, Product development (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 69 relations\n",
      "INFO: Query edges: Growth opportunities, Market advantages, Technology trends, Market expansion, Competitive positioning (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 56 entities, 70 relations, 0 vector chunks\n",
      "INFO: After truncation: 56 entities, 70 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 70 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 56 entities, 70 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E6/1 E9/2 E7/3 E11/4 E9/5 E8/6 E4/7 E11/8 E10/9 E3/10 E3/11 E9/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:95c76e5cdeb7d8b40c253a367af4ac78\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 56 entities, 70 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 144 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing opportunities for FICO\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:07a39e8bf3ef2022e5c4a90cf25c3428\n",
      "INFO: Query nodes: FICO, Financial services, Data analytics, Artificial intelligence, Cloud computing (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 73 relations\n",
      "INFO: Query edges: Growth opportunities, Market advantages, Technology trends, Market expansion, Competitive positioning (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 59 entities, 75 relations, 0 vector chunks\n",
      "INFO: After truncation: 59 entities, 75 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 75 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 59 entities, 75 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E5/1 E9/2 E11/3 E7/4 E9/5 E7/6 E8/7 E11/8 E3/9 E9/10 E3/11 E10/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:b616bd9c26d1da99c3c9de7652c4f8ac\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 59 entities, 75 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 144 chars, mode: hybrid\n",
      "INFO:updated_architectures.implementation.ice_simplified:Portfolio opportunity analysis completed for 5 holdings\n",
      "INFO:updated_architectures.implementation.ice_simplified:Analyzing market relationships...\n",
      "INFO:  == LLM cache == saving: global:keywords:f1e9f89046091329f897ba7ef354a9a4\n",
      "INFO: Query edges: Business relationships, Dependencies, Competitive dynamics (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 37 entites, 40 relations\n",
      "INFO: Raw search results: 37 entities, 40 relations, 0 vector chunks\n",
      "INFO: After truncation: 37 entities, 40 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 40 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 37 entities, 40 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E4/2 E6/3 E8/4 E7/5 E5/6 E5/7 E3/8 E6/9 E4/10 E5/11 E6/12\n",
      "INFO:  == LLM cache == saving: global:query:75a0d4975e3edfe91c59096149d0c7a9\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 37 entities, 40 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=global, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 158 chars, mode: global\n",
      "INFO:updated_architectures.implementation.ice_simplified:Portfolio analysis completed: 5/5 risk analyses successful\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udcca Analysis completed in 115.18s\n",
      "\ud83d\udcc5 Analysis timestamp: 2025-11-08T17:00:23.117680\n",
      "\n",
      "\ud83d\udcca Analysis Summary:\n",
      "  Total Holdings: 5\n",
      "  Risk Analyses: 5/5\n",
      "  Opportunity Analyses: 5/5\n",
      "  Completion Rate: 100.0%\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 12: Automated portfolio analysis using ICE intelligence\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# NOTE: This operation may take several minutes. If it hangs, restart kernel.\n",
    "\n",
    "print(f\"\\n\ud83c\udfaf Automated Portfolio Analysis\")\n",
    "print(f\"\u2501\" * 40)\n",
    "\n",
    "if not (ice and ice.core.is_ready()):\n",
    "    raise RuntimeError(\"ICE system not ready for portfolio analysis\")\n",
    "\n",
    "try:\n",
    "    # Execute comprehensive portfolio analysis\n",
    "    analysis_start = datetime.now()\n",
    "    analysis = ice.analyze_portfolio(holdings, include_opportunities=True)\n",
    "    analysis_time = (datetime.now() - analysis_start).total_seconds()\n",
    "    \n",
    "    print(f\"\ud83d\udcca Analysis completed in {analysis_time:.2f}s\")\n",
    "    print(f\"\ud83d\udcc5 Analysis timestamp: {analysis['timestamp']}\")\n",
    "    \n",
    "    # Display analysis summary\n",
    "    summary = analysis.get('summary', {})\n",
    "    print(f\"\\n\ud83d\udcca Analysis Summary:\")\n",
    "    print(f\"  Total Holdings: {summary.get('total_holdings', len(holdings))}\")\n",
    "    print(f\"  Risk Analyses: {summary.get('successful_risk_analyses', 0)}/{len(holdings)}\")\n",
    "    print(f\"  Opportunity Analyses: {summary.get('successful_opportunity_analyses', 0)}/{len(holdings)}\")\n",
    "    print(f\"  Completion Rate: {summary.get('analysis_completion_rate', 0):.1f}%\")\n",
    "    \n",
    "except Exception as e:\n",
    "    print(f\"\u274c Analysis error: {e}\")\n",
    "    raise  # Re-raise for proper debugging"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udcda Week 4: Source Attribution\n",
      "============================================================\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: hybrid:keywords:5f129fc57befc2e0fd5cdbd5172cf4a9\n",
      "INFO: Query nodes: NVDA, NVIDIA, Stock recommendation, Market outlook (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 38 entites, 64 relations\n",
      "INFO: Query edges: Goldman Sachs, Investment analysis, Stock market (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 36 entites, 40 relations\n",
      "INFO: Raw search results: 52 entities, 69 relations, 0 vector chunks\n",
      "INFO: After truncation: 52 entities, 69 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 69 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 52 entities, 69 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E9/3 E9/4 E7/5 E12/6 E3/7 E9/8 E9/9 E3/10 E4/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:de2f63f12feeb0d2b92b631b719d958b\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 52 entities, 69 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 27 chars, mode: hybrid\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 Answer: I do not have enough information to answer....\n",
      "\n",
      "\ud83d\udcda Sources Used (8 unique):\n",
      "   \u2022 email: CH_HK_ Tencent Music Entertainment (1698 HK)_ Stro\n",
      "   \u2022 entity: DBS, DTD, EN, NOTE, SVIP, TME, TR\n",
      "\n",
      "\ud83d\udcca Confidence: 70%\n",
      "\n",
      "\ud83d\udca1 Source attribution enables regulatory compliance and audit trails\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 13: Week 4 Feature Demo - Source Attribution\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"\ud83d\udcda Week 4: Source Attribution\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "result = ice.core.query(\"Goldman Sachs view on NVDA?\", mode='hybrid')\n",
    "\n",
    "if result.get('status') == 'success':\n",
    "    print(f\"\u2705 Answer: {result['answer'][:200]}...\")\n",
    "    \n",
    "    # Display detailed source attribution\n",
    "    sources = result.get('sources', [])\n",
    "    if sources:\n",
    "        print(f\"\\n\ud83d\udcda Sources Used ({len(sources)} unique):\")\n",
    "        source_groups = {}\n",
    "        for src in sources:\n",
    "            src_type = src['type']\n",
    "            if src_type not in source_groups:\n",
    "                source_groups[src_type] = []\n",
    "            source_groups[src_type].append(src['symbol'])\n",
    "        \n",
    "        for src_type, symbols in sorted(source_groups.items()):\n",
    "            symbol_str = ', '.join(sorted(set(symbols)))\n",
    "            print(f\"   \u2022 {src_type}: {symbol_str}\")\n",
    "    else:\n",
    "        print(f\"\\n\u26a0\ufe0f  No explicit SOURCE markers found in answer\")\n",
    "        print(f\"   (This may occur if answer synthesizes multiple sources)\")\n",
    "    \n",
    "    # Display confidence if available\n",
    "    confidence = result.get('confidence')\n",
    "    if confidence is not None:\n",
    "        print(f\"\\n\ud83d\udcca Confidence: {confidence:.0%}\")\n",
    "    \n",
    "    print(\"\\n\ud83d\udca1 Source attribution enables regulatory compliance and audit trails\")\n",
    "else:\n",
    "    print(f\"\u274c Failed: {result.get('message')}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 14\n",
    "\n",
    "## 4c. Week 4 Feature: Source Attribution & Traceability\n",
    "\n",
    "**Compliance-Ready Intelligence**: Every fact in ICE's responses includes source attribution for regulatory compliance.\n",
    "\n",
    "**Source Tracking**:\n",
    "- **Document IDs**: Each fact links to source document\n",
    "- **Extraction Metadata**: Includes confidence scores and extraction method\n",
    "- **Citation Chains**: Multi-hop reasoning shows complete inference path\n",
    "\n",
    "**Business Value**:\n",
    "- **Regulatory Compliance**: Meet audit and documentation requirements\n",
    "- **Trust & Transparency**: Users can verify all claims\n",
    "- **Quality Assurance**: Low-confidence facts are flagged\n",
    "\n",
    "**Implementation**: Source metadata is automatically captured during graph building and preserved through query processing."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udd04 Week 4: Query Fallback Logic\n",
      "============================================================\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: mix:keywords:a7d69a7d3a3b118f8e9f17c3d28a705f\n",
      "INFO: Query nodes: Risk cascade, Investment strategy, Market volatility, Economic factors (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 20 entites, 34 relations\n",
      "INFO: Query edges: Geopolitical risk, Portfolio management, Risk assessment (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 44 entites, 40 relations\n",
      "INFO: Naive query: 8 chunks (chunk_top_k:20 cosine:0.2)\n",
      "INFO: Raw search results: 51 entities, 55 relations, 8 vector chunks\n",
      "INFO: After truncation: 51 entities, 55 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 55 relations\n",
      "INFO: Round-robin merged chunks: 20 -> 12 (deduplicated 8)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 51 entities, 55 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E7/1 E9/2 E13/3 E7/4 E8/5 E7/6 E8/7 E4/8 E8/9 E3/10 E8/11 E4/12\n",
      "INFO:  == LLM cache == saving: mix:query:d128e47fe74ba954c20a34355130f533\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 51 entities, 55 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=mix, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 36 chars, mode: mix\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 Query successful\n",
      "   Requested: mix | Actual: mix\n",
      "   Fallback: No\n",
      "   Answer: I do not have enough information to answer....\n",
      "\n",
      "\ud83d\udca1 Automatic robustness - queries succeed even if advanced modes fail\n",
      "   (Fallback cascade: mix \u2192 hybrid \u2192 local)\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 15: Week 4 Feature Demo - Query Fallback Logic\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"\ud83d\udd04 Week 4: Query Fallback Logic\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "# Fallback logic is automatic - system gracefully handles mode failures\n",
    "result = ice.core.query(\"Portfolio geopolitical risk cascade?\", mode='mix')\n",
    "\n",
    "if result.get('status') == 'success':\n",
    "    actual_mode = result.get('mode_used', result.get('query_mode', 'mix'))\n",
    "    print(f\"\u2705 Query successful\")\n",
    "    print(f\"   Requested: mix | Actual: {actual_mode}\")\n",
    "    print(f\"   Fallback: {'Yes' if actual_mode != 'mix' else 'No'}\")\n",
    "    print(f\"   Answer: {result['answer'][:120]}...\")\n",
    "else:\n",
    "    print(f\"\u274c Failed: {result.get('message')}\")\n",
    "\n",
    "print(\"\\n\ud83d\udca1 Automatic robustness - queries succeed even if advanced modes fail\")\n",
    "print(\"   (Fallback cascade: mix \u2192 hybrid \u2192 local)\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 16\n",
    "\n",
    "## 4b. Week 4 Feature: Automatic Fallback (mix \u2192 hybrid \u2192 local)\n",
    "\n",
    "**Robust Query Processing**: ICEQueryProcessor implements automatic fallback logic to ensure queries always succeed.\n",
    "\n",
    "**Fallback Cascade**:\n",
    "1. **mix mode** - Attempts combined vector + graph retrieval\n",
    "2. **hybrid mode** - Falls back to entity-focused analysis\n",
    "3. **local mode** - Final fallback to simple semantic search\n",
    "\n",
    "**Benefit**: Users don't need to worry about mode selection - the system automatically finds the best working strategy.\n",
    "\n",
    "**Implementation**: Fallback logic is internal and automatic. Queries specify desired mode but system handles degradation gracefully."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\ude80 Week 4: ICEQueryProcessor Integration\n",
      "============================================================\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: hybrid:keywords:adde3d5ccb86eecc8c2b57a36123e3c3\n",
      "INFO: Query nodes: NVIDIA, Taiwan Semiconductor Manufacturing Company, Manufacturing delays, Component shortages, Geopolitical factors (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 9 entites, 19 relations\n",
      "INFO: Query edges: Supply chain risks, NVDA, TSMC (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 43 entites, 37 relations\n",
      "INFO: Raw search results: 44 entities, 38 relations, 0 vector chunks\n",
      "INFO: After truncation: 44 entities, 38 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 38 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 44 entities, 38 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E9/2 E7/3 E4/4 E5/5 E7/6 E8/7 E9/8 E5/9 E6/10 E5/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:8fb294e30a36ac36aa6f96254c570dcf\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 44 entities, 38 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 48 chars, mode: hybrid\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u2705 Enhanced Query Processing\n",
      "   Answer: I do not have enough information to answer....\n",
      "   Features: Multi-hop reasoning + confidence scoring\n",
      "\n",
      "\ud83d\udca1 ICEQueryProcessor provides:\n",
      "   - Multi-hop reasoning\n",
      "   - Automatic fallback logic\n",
      "   - Source attribution\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 17: Week 4 Feature Demo - ICEQueryProcessor Integration\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"\ud83d\ude80 Week 4: ICEQueryProcessor Integration\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "query = \"What are NVDA's supply chain risks through TSMC?\"\n",
    "\n",
    "result_enhanced = ice.core.query(query, mode='hybrid')\n",
    "\n",
    "if result_enhanced.get('status') == 'success':\n",
    "    print(f\"\u2705 Enhanced Query Processing\")\n",
    "    print(f\"   Answer: {result_enhanced['answer'][:150]}...\")\n",
    "    print(f\"   Features: Multi-hop reasoning + confidence scoring\")\n",
    "else:\n",
    "    print(f\"\u274c Status: {result_enhanced.get('status')}\")\n",
    "    \n",
    "print(\"\\n\ud83d\udca1 ICEQueryProcessor provides:\")\n",
    "print(\"   - Multi-hop reasoning\")\n",
    "print(\"   - Automatic fallback logic\")\n",
    "print(\"   - Source attribution\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 18\n",
    "\n",
    "## 4a. Week 4 Feature: Enhanced Query Processing (ICEQueryProcessor)\n",
    "\n",
    "**ICEQueryProcessor Integration**: Week 4 adds sophisticated query processing capabilities to ICE.\n",
    "\n",
    "**Key Features**:\n",
    "- **Multi-hop Reasoning**: Follow relationships across 1-3 hops in knowledge graph\n",
    "- **Automatic Fallback**: Queries gracefully degrade if advanced modes fail (mix \u2192 hybrid \u2192 local)\n",
    "- **Source Attribution**: Every fact traces to source documents\n",
    "- **Confidence Scoring**: Results include reliability metrics"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "============================================================\n",
      "\ud83d\udcca Portfolio Holdings: NVDA, TSMC, AMD, ASML, FICO\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "ERROR:src.ice_lightrag.ice_rag_fixed:LightRAG response structure error: LightRAG response missing required field: data\n",
      "Traceback (most recent call last):\n",
      "  File \"/Users/royyeo/Library/CloudStorage/OneDrive-NationalUniversityofSingapore/Capstone Project/src/ice_lightrag/ice_rag_fixed.py\", line 302, in query\n",
      "    raise ValueError(\"LightRAG response missing required field: data\")\n",
      "ValueError: LightRAG response missing required field: data\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 0 chars, mode: hybrid\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\ud83d\udd0d Executing: '' (mode: hybrid)\n",
      "\n",
      "\u274c Error: Invalid response structure: LightRAG response missing required field: data\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 19: Manual query input - Interactive\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"=\" * 60)\n",
    "print(f\"\ud83d\udcca Portfolio Holdings: {', '.join(holdings)}\")\n",
    "query = input(\"\ud83d\udcac Enter your investment question: \")\n",
    "mode = input(\"\ud83d\udcca Query mode (naive/local/global/hybrid/mix/bypass) [hybrid]: \") or \"hybrid\"\n",
    "\n",
    "print(f\"\\n\ud83d\udd0d Executing: '{query}' (mode: {mode})\")\n",
    "result = ice.core.query(query, mode=mode)\n",
    "\n",
    "if result.get('status') == 'success':\n",
    "    print(f\"\\n\u2705 Answer:\\n{result['answer']}\")\n",
    "else:\n",
    "    print(f\"\\n\u274c Error: {result.get('message')}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 20\n",
    "\n",
    "## 3. LightRAG Query Mode Testing & Comparison"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\ud83d\udd0d Query Mode Testing & Performance Comparison\n",
      "\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n",
      "\ud83d\udcca Test Query: 'What are the biggest risks for my semiconductor portfolio?'\n",
      "\n",
      "\ud83e\uddea Testing All Query Modes:\n",
      "\n",
      "NAIVE MODE:\n",
      "  Use Case: Quick factual lookup without graph context relationships\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Naive query: 12 chunks (chunk_top_k:20 cosine:0.2)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 12 chunks\n",
      "INFO:  == LLM cache == saving: naive:query:185f892e203b5235386a5aa89637974b\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 0 entities, 0 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=naive, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 58 chars, mode: naive\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  \u2705 Response: I do not have enough information to answer.\n",
      "  \u23f1\ufe0f Time: 6.12s\n",
      "\n",
      "LOCAL MODE:\n",
      "  Use Case: Deep dive into specific entities (companies) and their immediate relationships\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: local:keywords:4fea0dc61826f0b82d89e34bc44c1cb4\n",
      "INFO: Query nodes: Market volatility, Supply chain issues, Technological advancements, Regulatory changes, Competition (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 16 entites, 26 relations\n",
      "INFO: Raw search results: 16 entities, 26 relations, 0 vector chunks\n",
      "INFO: After truncation: 16 entities, 26 relations\n",
      "INFO: Selecting 8 from 8 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 26 relations\n",
      "INFO: Round-robin merged chunks: 8 -> 8 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 16 entities, 26 relations, 8 chunks\n",
      "INFO: Final chunks S+F/O: E3/1 E1/2 E1/3 E2/4 E4/5 E3/6 E1/7 E3/8\n",
      "INFO:  == LLM cache == saving: local:query:232678604adddd1ec9d6258819abe649\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 16 entities, 26 relationships, 8 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=local, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 58 chars, mode: local\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  \u2705 Response: I do not have enough information to answer.\n",
      "  \u23f1\ufe0f Time: 3.69s\n",
      "\n",
      "GLOBAL MODE:\n",
      "  Use Case: Broad market trends and high-level relationship analysis\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: global:keywords:30b1412e8907ce76c8233d23b88d0413\n",
      "INFO: Query edges: Semiconductor portfolio, Investment risks, Market volatility (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 44 entites, 40 relations\n",
      "INFO: Raw search results: 44 entities, 40 relations, 0 vector chunks\n",
      "INFO: After truncation: 44 entities, 40 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 40 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 44 entities, 40 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E8/3 E9/4 E3/5 E9/6 E3/7 E5/8 E9/9 E7/10 E6/11 E3/12\n",
      "INFO:  == LLM cache == saving: global:query:32d1a61e334f43c3c1a7bb5696dc55ad\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 44 entities, 40 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=global, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 58 chars, mode: global\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  \u2705 Response: I do not have enough information to answer.\n",
      "  \u23f1\ufe0f Time: 8.00s\n",
      "\n",
      "HYBRID MODE:\n",
      "  Use Case: Complex analysis combining entity details with relationship context\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: hybrid:keywords:24904832fc1e36347412680a424c1b52\n",
      "INFO: Query nodes: Supply chain issues, Technological advancements, Regulatory changes, Market competition, Economic downturn (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 4 entites, 10 relations\n",
      "INFO: Query edges: Semiconductor portfolio, Investment risks, Market volatility (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 44 entites, 40 relations\n",
      "INFO: Raw search results: 44 entities, 45 relations, 0 vector chunks\n",
      "INFO: After truncation: 44 entities, 45 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 45 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 44 entities, 45 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E8/3 E9/4 E3/5 E9/6 E3/7 E5/8 E9/9 E7/10 E6/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:0053edc2163fa2273fc90cef3304291a\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 44 entities, 45 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 58 chars, mode: hybrid\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  \u2705 Response: I do not have enough information to answer.\n",
      "  \u23f1\ufe0f Time: 6.61s\n",
      "\n",
      "MIX MODE:\n",
      "  Use Case: DEFAULT MODE - Combines vector similarity with graph-based retrieval for balanced results\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: mix:keywords:7143ba32aec4114688d21e1a5535c431\n",
      "INFO: Query nodes: Supply chain issues, Technological advancements, Regulatory changes, Market demand, Competition (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 4 entites, 9 relations\n",
      "INFO: Query edges: Semiconductor portfolio, Investment risks, Market volatility (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 44 entites, 40 relations\n",
      "INFO: Naive query: 12 chunks (chunk_top_k:20 cosine:0.2)\n",
      "INFO: Raw search results: 45 entities, 45 relations, 12 vector chunks\n",
      "INFO: After truncation: 45 entities, 45 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 45 relations\n",
      "INFO: Round-robin merged chunks: 24 -> 12 (deduplicated 12)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 45 entities, 45 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E6/2 E8/3 E9/4 E3/5 E9/6 E3/7 E6/8 E9/9 E7/10 E6/11 E3/12\n",
      "INFO:  == LLM cache == saving: mix:query:f8d47d472d14842e8ad4b6733ee090f5\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 45 entities, 45 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=mix, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 58 chars, mode: mix\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  \u2705 Response: I do not have enough information to answer.\n",
      "  \u23f1\ufe0f Time: 4.26s\n",
      "\n",
      "BYPASS MODE:\n",
      "  Use Case: Direct LLM reasoning without knowledge graph retrieval\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 0 entities, 0 relationships, 0 chunks\n",
      "WARNING:src.ice_lightrag.ice_rag_fixed:No SOURCE markers found in context - check data ingestion pipeline\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=bypass, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 58 chars, mode: bypass\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  \u2705 Response: Investing in a semiconductor portfolio can be lucrative, but it also comes with several risks. Here are some of the biggest risks to consider:\n",
      "\n",
      "1. **M...\n",
      "  \u23f1\ufe0f Time: 14.82s\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 21: Test all 6 LightRAG query modes with investment question\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# NOTE: Testing all modes takes ~2 minutes. Each query may take 15-20s.\n",
    "\n",
    "# === TENCENT TABLE IMAGE EXTRACTION TEST QUERIES ===\n",
    "# These queries validate that inline image table extraction is working correctly.\n",
    "# All answers can ONLY be found in the image table (image001.png) in 'Tencent Q2 2025 Earnings.eml',\n",
    "# NOT in the email HTML body content.\n",
    "#\n",
    "# Test Query 1 (Hard - Multi-row comparison):\n",
    "# \"Which business segment had the highest year-over-year growth rate in Tencent's Q2 2025 earnings?\"\n",
    "# Expected Answer: International Games (35% YoY growth)\n",
    "# Tests: Multi-row comparison, YoY column extraction, finding maximum value\n",
    "#\n",
    "# Test Query 2 (Medium - QoQ analysis):\n",
    "# \"Did Tencent's domestic games revenue increase or decrease from Q1 2025 to Q2 2025?\"\n",
    "# Expected Answer: Decreased by 6% (QoQ: -6%)\n",
    "# Tests: Single-row QoQ analysis, negative percentage interpretation, sequential comparison\n",
    "#\n",
    "# Test Query 3 (Easy - Direct lookup):\n",
    "# \"What was Tencent's operating margin in Q2 2024?\"\n",
    "# Expected Answer: 36.3%\n",
    "# Tests: Direct lookup, historical period selection, percentage format, margin metric extraction\n",
    "# =================================================\n",
    "\n",
    "print(f\"\\n\ud83d\udd0d Query Mode Testing & Performance Comparison\")\n",
    "print(f\"\u2501\" * 50)\n",
    "\n",
    "test_query = \"What are the biggest risks for my semiconductor portfolio?\"\n",
    "print(f\"\ud83d\udcca Test Query: '{test_query}'\")\n",
    "\n",
    "# Mode descriptions with investment context\n",
    "modes_with_descriptions = {\n",
    "    'naive': \"Quick factual lookup without graph context relationships\",\n",
    "    'local': \"Deep dive into specific entities (companies) and their immediate relationships\",\n",
    "    'global': \"Broad market trends and high-level relationship analysis\",\n",
    "    'hybrid': \"Complex analysis combining entity details with relationship context\",\n",
    "    'mix': \"DEFAULT MODE - Combines vector similarity with graph-based retrieval for balanced results\",\n",
    "    'bypass': \"Direct LLM reasoning without knowledge graph retrieval\"\n",
    "}\n",
    "\n",
    "mode_results = {}\n",
    "\n",
    "if not (ice and ice.core.is_ready()):\n",
    "    raise RuntimeError(\"Cannot test query modes without initialized system\")\n",
    "\n",
    "print(f\"\\n\ud83e\uddea Testing All Query Modes:\")\n",
    "\n",
    "for mode, description in modes_with_descriptions.items():\n",
    "    print(f\"\\n{mode.upper()} MODE:\")\n",
    "    print(f\"  Use Case: {description}\")\n",
    "    \n",
    "    try:\n",
    "        query_start = datetime.now()\n",
    "        result = ice.core.query(test_query, mode=mode)\n",
    "        query_time = (datetime.now() - query_start).total_seconds()\n",
    "        \n",
    "        if result.get('status') == 'success' and result.get('answer'):\n",
    "            answer = result['answer']\n",
    "            metrics = result.get('metrics', {})\n",
    "            \n",
    "            print(f\"  \u2705 Response: {answer[:150]}{'...' if len(answer) > 150 else ''}\")\n",
    "            print(f\"  \u23f1\ufe0f Time: {query_time:.2f}s\")\n",
    "            \n",
    "            if metrics:\n",
    "                print(f\"  \ud83d\udcca Query Mode: {metrics.get('query_mode', mode)}\")\n",
    "                print(f\"  \ud83d\udcdd Answer Length: {metrics.get('answer_length', len(answer))} chars\")\n",
    "                if 'api_cost_estimated' in metrics:\n",
    "                    print(f\"  \ud83d\udcb0 Est. Cost: {metrics['api_cost_estimated']}\")\n",
    "            \n",
    "            # Store for comparison\n",
    "            mode_results[mode] = {\n",
    "                'success': True,\n",
    "                'answer': answer,\n",
    "                'time': query_time,\n",
    "                'length': len(answer)\n",
    "            }\n",
    "        else:\n",
    "            print(f\"  \u274c Status: {result.get('status', 'unknown')}\")\n",
    "            print(f\"  \ud83d\udccb Message: {result.get('message', 'No response available')}\")\n",
    "            mode_results[mode] = {'success': False, 'time': query_time}\n",
    "            \n",
    "    except Exception as e:\n",
    "        print(f\"  \u274c Error: {str(e)[:80]}...\")\n",
    "        mode_results[mode] = {'success': False, 'error': str(e)}"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 22\n",
    "\n",
    "## 5. Query Evaluation Framework\n",
    "\n",
    "**Automated Quality Assessment**: Evaluate ICE query responses using defensive metrics.\n",
    "\n",
    "### Metrics\n",
    "- **Faithfulness**: How well grounded the answer is in retrieved context\n",
    "- **Relevancy**: How well the answer addresses the query\n",
    "- **Entity F1**: Ticker symbol extraction accuracy (if reference provided)\n",
    "\n",
    "### Approach\n",
    "- **Rule-based**: No LLM calls, cost-free evaluation\n",
    "- **Defensive**: Explicit error tracking, no silent failures\n",
    "- **Small batches**: 3 queries at a time to avoid rate limits\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\ud83d\udccb Loading Test Queries\n",
      "============================================================\n",
      "\u2705 Loaded 8 queries from test_queries_1.xlsx\n",
      "\n",
      "\ud83d\udcca Test Set Composition:\n",
      "   Queries: 8\n",
      "   With reference: 8\n",
      "\n",
      "Queries:\n",
      "   Q1: What is Tencent's operating margin in Q2 2025?...\n",
      "   Q2: What are Tencent's international games?...\n",
      "   Q3: What is Tencent Music Entertainment's 2Q 2024 paying users?...\n",
      "   Q4: What is TME's tiered monetization strategy?...\n",
      "   Q5: What is TME's music streaming service revenue?...\n",
      "   Q6: Which business segment had the highest year-over-year growth rate in Tencent's Q2 2025 earnings?...\n",
      "   Q7: Did Tencent's domestic games revenue increase or decrease from Q1 2025 to Q2 2025?...\n",
      "   Q8: What was Tencent's operating margin in Q2 2024?...\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 23: Load or create test queries\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"\ud83d\udccb Loading Test Queries\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "# test_queries_filename = 'test_queries.xlsx' \n",
    "test_queries_filename = 'test_queries_1.xlsx' \n",
    "\n",
    "try:\n",
    "    test_queries_df = pd.read_excel(test_queries_filename, engine='openpyxl')\n",
    "    print(f\"\u2705 Loaded {len(test_queries_df)} queries from {test_queries_filename}\")\n",
    "    \n",
    "    # Ensure required columns exist\n",
    "    if 'query_id' not in test_queries_df.columns:\n",
    "        test_queries_df['query_id'] = [f\"Q{i+1}\" for i in range(len(test_queries_df))]\n",
    "    if 'query_text' not in test_queries_df.columns and 'query' in test_queries_df.columns:\n",
    "        test_queries_df['query_text'] = test_queries_df['query']\n",
    "    \n",
    "except FileNotFoundError:\n",
    "    print(\"\u26a0\ufe0f test_queries.xlsx not found - creating default test set\")\n",
    "    \n",
    "    # Default test queries covering key use cases\n",
    "    default_queries = [\n",
    "        {\n",
    "            'query_id': 'Q1',\n",
    "            'query_text': 'What are the key risks for NVDA?',\n",
    "            'reference': 'NVDA faces supply chain risks through TSMC, intense competition from AMD and Intel, and regulatory concerns.'\n",
    "        },\n",
    "        {\n",
    "            'query_id': 'Q2',\n",
    "            'query_text': 'Which semiconductor stocks have positive analyst ratings?',\n",
    "            'reference': 'NVDA has BUY ratings from Goldman Sachs. TSMC has positive outlook.'\n",
    "        },\n",
    "        {\n",
    "            'query_id': 'Q3',\n",
    "            'query_text': 'Summarize the latest earnings for my portfolio holdings',\n",
    "            'reference': 'NVDA reported strong Q2 earnings with revenue growth. TSMC manufacturing capacity expansion.'\n",
    "        }\n",
    "    ]\n",
    "    \n",
    "    test_queries_df = pd.DataFrame(default_queries)\n",
    "    print(f\"\u2705 Created {len(test_queries_df)} default test queries\")\n",
    "\n",
    "print(f\"\\n\ud83d\udcca Test Set Composition:\")\n",
    "print(f\"   Queries: {len(test_queries_df)}\")\n",
    "print(f\"   With reference: {test_queries_df['reference'].notna().sum() if 'reference' in test_queries_df.columns else 0}\")\n",
    "print(f\"\\nQueries:\")\n",
    "for _, row in test_queries_df.iterrows():\n",
    "    print(f\"   {row['query_id']}: {row['query_text'][:150]}...\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:src.ice_evaluation.minimal_evaluator:\u2705 Configuration validated: batch_size=3, model=gpt-4o-mini\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0d Starting evaluation of 8 queries in batches of 3\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udce6 Processing batch 1/3\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q1\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\ud83d\udd0d Initializing Evaluation Framework\n",
      "============================================================\n",
      "\u2705 Evaluator initialized\n",
      "   Batch size: 3\n",
      "   Fail-fast: False\n",
      "\n",
      "\ud83d\ude80 Running Evaluation on 8 queries...\n",
      "   This may take ~80s (8q \u00d7 ~10s/query)\n",
      "============================================================\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:  == LLM cache == saving: hybrid:keywords:769618f0c52389b8f5ddf4c21400d2ce\n",
      "INFO: Query nodes: Financial performance, Quarterly report, Revenue, Profit margin (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 64 relations\n",
      "INFO: Query edges: Tencent, Operating margin, Q2 2025 (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 56 entities, 68 relations, 0 vector chunks\n",
      "INFO: After truncation: 56 entities, 68 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 68 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 56 entities, 68 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E13/1 E7/2 E11/3 E10/4 E9/5 E7/6 E8/7 E5/8 E8/9 E4/10 E5/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:3a0335944165ade09107ba820003b289\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 56 entities, 68 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 46 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q2\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:5271e140ffb1d8371730db6599da89ae\n",
      "INFO: Query nodes: Game titles, Mobile games, PC games, Global market, Game development (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 61 relations\n",
      "INFO: Query edges: Tencent, International games (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 39 entites, 40 relations\n",
      "INFO: Raw search results: 49 entities, 62 relations, 0 vector chunks\n",
      "INFO: After truncation: 49 entities, 62 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 62 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 49 entities, 62 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E9/1 E9/2 E9/3 E10/4 E10/5 E8/6 E3/7 E2/8 E8/9 E9/10 E2/11 E1/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:da9fa8873c5287c715dec592e06de59f\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 49 entities, 62 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 39 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q3\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:631f3b985d2a7290d994735d9ed93b25\n",
      "INFO: Query nodes: User statistics, Subscription numbers, Revenue, Music streaming (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 48 relations\n",
      "INFO: Query edges: Tencent Music Entertainment, 2Q 2024, Paying users (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 41 entites, 39 relations\n",
      "INFO: Raw search results: 49 entities, 52 relations, 0 vector chunks\n",
      "INFO: After truncation: 49 entities, 52 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 52 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 49 entities, 52 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E10/1 E12/2 E11/3 E7/4 E9/5 E5/6 E6/7 E3/8 E6/9 E4/10 E3/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:b3274ea5d04d7f1f70d3220ce6f17776\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 49 entities, 52 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 59 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udce6 Processing batch 2/3\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q4\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:7ef2c0fdbba8616eac13e2b8cab02b10\n",
      "INFO: Query nodes: Monetization, Business model, Revenue streams (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 35 entites, 37 relations\n",
      "INFO: Query edges: TME, Tiered monetization strategy (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 36 entites, 34 relations\n",
      "INFO: Raw search results: 42 entities, 37 relations, 0 vector chunks\n",
      "INFO: After truncation: 42 entities, 37 relations\n",
      "INFO: Selecting 11 from 11 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 37 relations\n",
      "INFO: Round-robin merged chunks: 11 -> 11 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 42 entities, 37 relations, 11 chunks\n",
      "INFO: Final chunks S+F/O: E11/1 E10/2 E13/3 E9/4 E7/5 E3/6 E4/7 E3/8 E3/9 E2/10 E2/11\n",
      "INFO:  == LLM cache == saving: hybrid:query:526e4333fcfdee035273969ee8036a39\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 42 entities, 37 relationships, 11 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 43 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q5\n",
      "INFO: Query nodes: TME, Tencent Music Entertainment, Market analysis, Financial report (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 53 relations\n",
      "INFO: Query edges: Music streaming service, Revenue (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 49 entities, 57 relations, 0 vector chunks\n",
      "INFO: After truncation: 49 entities, 57 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 57 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 49 entities, 57 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E10/1 E12/2 E11/3 E9/4 E7/5 E5/6 E6/7 E3/8 E3/9 E9/10 E3/11 E3/12\n",
      "INFO:  == LLM cache == Query cache hit, using cached response as query result\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 49 entities, 57 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 46 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q6\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:95bda1012fb7969151c57d2e400bbb23\n",
      "INFO: Query nodes: Tencent, Earnings report, Growth rate, Financial performance, Quarterly results (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 57 relations\n",
      "INFO: Query edges: Business segment, Year-over-year growth rate, Tencent Q2 2025 earnings (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 37 entites, 40 relations\n",
      "INFO: Raw search results: 47 entities, 60 relations, 0 vector chunks\n",
      "INFO: After truncation: 47 entities, 60 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 60 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 47 entities, 60 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E7/1 E9/2 E10/3 E12/4 E9/5 E6/6 E7/7 E3/8 E8/9 E5/10 E3/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:2a20c96aebe53a400a7ec103a7e1a522\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 47 entities, 60 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 96 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udce6 Processing batch 3/3\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q7\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:c9a358c799d5987c3c21297458efb3b3\n",
      "INFO: Query nodes: Q1 2025, Q2 2025, Revenue increase, Revenue decrease (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 28 entites, 33 relations\n",
      "INFO: Query edges: Tencent, Domestic games revenue, Quarterly revenue analysis (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 39 entites, 40 relations\n",
      "INFO: Raw search results: 48 entities, 45 relations, 0 vector chunks\n",
      "INFO: After truncation: 48 entities, 45 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 45 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 48 entities, 45 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E13/1 E10/2 E7/3 E10/4 E9/5 E7/6 E7/7 E2/8 E6/9 E5/10 E3/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:aa1ada28b73f56d40c79874718b7ea97\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 48 entities, 45 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 82 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udd0e Evaluating query: Q8\n",
      "INFO:  == LLM cache == saving: hybrid:keywords:40a31cbffd9b2020c23247e03548e527\n",
      "INFO: Query nodes: Financial performance, Quarterly report, Profitability, Revenue (top_k:40, cosine:0.2)\n",
      "INFO: Local query: 40 entites, 67 relations\n",
      "INFO: Query edges: Tencent, Operating margin, Q2 2024 (top_k:40, cosine:0.2)\n",
      "INFO: Global query: 40 entites, 40 relations\n",
      "INFO: Raw search results: 58 entities, 71 relations, 0 vector chunks\n",
      "INFO: After truncation: 58 entities, 71 relations\n",
      "INFO: Selecting 12 from 12 entity-related chunks by vector similarity\n",
      "INFO: Find no additional relations-related chunks from 71 relations\n",
      "INFO: Round-robin merged chunks: 12 -> 12 (deduplicated 0)\n",
      "WARNING: Rerank is enabled but no rerank model is configured. Please set up a rerank model or set enable_rerank=False in query parameters.\n",
      "INFO: Final context: 58 entities, 71 relations, 12 chunks\n",
      "INFO: Final chunks S+F/O: E13/1 E7/2 E11/3 E10/4 E9/5 E6/6 E9/7 E6/8 E9/9 E6/10 E4/11 E3/12\n",
      "INFO:  == LLM cache == saving: hybrid:query:78c764ec2c426fee46064ffea8c530b4\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Parsed context: Retrieved 58 entities, 71 relationships, 12 chunks\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Extracted 8 unique sources: ['email', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction', 'entity_extraction']\n",
      "INFO:src.ice_lightrag.ice_rag_fixed:Calculated confidence: 0.70 from 14 scores\n",
      "INFO:src.ice_core.ice_system_manager:ICE query completed: mode=hybrid, graph_context=False\n",
      "INFO:updated_architectures.implementation.ice_simplified:Query completed: 47 chars, mode: hybrid\n",
      "INFO:ICEMinimalEvaluator:============================================================\n",
      "INFO:ICEMinimalEvaluator:\ud83d\udcca EVALUATION SUMMARY\n",
      "INFO:ICEMinimalEvaluator:============================================================\n",
      "INFO:ICEMinimalEvaluator:Total Queries: 8\n",
      "INFO:ICEMinimalEvaluator:\u2705 Successful: 8 (100.0%)\n",
      "INFO:ICEMinimalEvaluator:\u26a0\ufe0f Partial: 0\n",
      "INFO:ICEMinimalEvaluator:\u274c Failed: 0 (0.0%)\n",
      "INFO:ICEMinimalEvaluator:============================================================\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\u2705 Evaluation Complete in 62.7s\n",
      "   Average: 7.8s per query\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 24: Initialize evaluator and run evaluation\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "\n",
    "print(\"\\n\ud83d\udd0d Initializing Evaluation Framework\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "from src.ice_evaluation import ICEMinimalEvaluator, MinimalEvaluationConfig\n",
    "\n",
    "# Configure evaluator with defensive settings\n",
    "config = MinimalEvaluationConfig(\n",
    "    batch_size=3,  # Small batches to avoid rate limits\n",
    "    max_retries=2,\n",
    "    fail_fast=False  # Continue on failures\n",
    ")\n",
    "\n",
    "evaluator = ICEMinimalEvaluator(config)\n",
    "print(\"\u2705 Evaluator initialized\")\n",
    "print(f\"   Batch size: {config.batch_size}\")\n",
    "print(f\"   Fail-fast: {config.fail_fast}\")\n",
    "\n",
    "# Run evaluation\n",
    "print(f\"\\n\ud83d\ude80 Running Evaluation on {len(test_queries_df)} queries...\")\n",
    "print(f\"   This may take ~{len(test_queries_df) * 10}s ({len(test_queries_df)}q \u00d7 ~10s/query)\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "eval_start = datetime.now()\n",
    "\n",
    "# Pass ice.core (ICEQueryProcessor) to evaluator\n",
    "results_df = evaluator.evaluate_queries(test_queries_df, ice.core)\n",
    "\n",
    "eval_duration = (datetime.now() - eval_start).total_seconds()\n",
    "\n",
    "print(f\"\\n\u2705 Evaluation Complete in {eval_duration:.1f}s\")\n",
    "print(f\"   Average: {eval_duration/len(test_queries_df):.1f}s per query\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\ud83d\udcca Evaluation Results Summary\n",
      "============================================================\n",
      "\n",
      "\ud83d\udcc8 Status Distribution:\n",
      "   \u2705 SUCCESS: 8/8 (100.0%)\n",
      "\n",
      "\ud83d\udcca Metric Scores (n=8):\n",
      "   Faithfulness   : \u03bc=0.633, \u03c3=0.054, min=0.548, max=0.674\n",
      "   Relevancy      : \u03bc=0.346, \u03c3=0.315, min=0.000, max=0.786\n",
      "   Entity_F1      : \u03bc=0.240, \u03c3=0.152, min=0.000, max=0.439\n",
      "\n",
      "\ud83d\udcdd Query-Response Pairs:\n",
      "============================================================\n",
      "\n",
      "Q1: What is Tencent's operating margin in Q2 2025?\n",
      "In Q2 2025, Tencent Music Entertainment reported an operating margin of 30.7%. This figure is derived from the operating income of RMB 2,593 million against the total revenue of RMB 8,442 million for that quarter. \n",
      "\n",
      "### References\n",
      "\n",
      "- [1] email:CH_HK_ Tencent Music Entertainment (1698 HK)_ Stronger growth with expanding revenue streams  (NOT RATED).eml\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q2: What are Tencent's international games?\n",
      "I do not have enough information to answer that.\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q3: What is Tencent Music Entertainment's 2Q 2024 paying users?\n",
      "In the 2Q24, Tencent Music Entertainment reported a total of **117.0 million** paying users. This figure reflects the number of users who subscribe to their services during that quarter. \n",
      "\n",
      "### References\n",
      "\n",
      "- [1] email:CH_HK_ Tencent Music Entertainment (1698 HK)_ Stronger growth with expanding revenue streams  (NOT RATED).eml\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q4: What is TME's tiered monetization strategy?\n",
      "Tencent Music Entertainment (TME) employs a **tiered monetization strategy** aimed at driving structural revenue growth. This strategy includes the following key components:\n",
      "\n",
      "1. **Targeting Mass Users via Ads**: TME focuses on monetizing its large base of non-paying users through advertising. This approach allows the company to generate revenue from users who do not currently subscribe to paid services.\n",
      "\n",
      "2. **Upselling Music Lovers**: For users who show a higher engagement with music content, TME aims to upsell them to premium services. This is achieved through enhanced content and user engagement strategies, particularly through the adoption of premium plans like SVIP.\n",
      "\n",
      "3. **Incentivised Ads**: The strategy incorporates incentivised ads, which are designed to encourage user engagement and increase revenue. This method has been effective in boosting music subscription revenue.\n",
      "\n",
      "4. **Expansion of Offline Concerts and Merchandise**: TME is also expanding its revenue streams through offline concerts and merchandise sales, which not only contribute to revenue but also enhance user engagement.\n",
      "\n",
      "5. **Bubble Interactive Fans Platform**: This platform is set to include Chinese artists and aims to boost engagement among young users, particularly through live-streaming, thereby increasing social entertainment revenue.\n",
      "\n",
      "Overall, TME's tiered monetization strategy is structured to maximize revenue from both non-paying and paying users by leveraging advertising, premium subscriptions, and enhanced user engagement initiatives. \n",
      "\n",
      "### References\n",
      "\n",
      "- [1] email:CH_HK_ Tencent Music Entertainment (1698 HK)_ Stronger growth with expanding revenue streams  (NOT RATED).eml\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q5: What is TME's music streaming service revenue?\n",
      "Tencent Music Entertainment (TME) reported a music subscription revenue of **RMB4.38 billion** for the second quarter of 2025, marking a **17% year-over-year increase** mainly driven by the adoption of its premium subscription plan, known as SVIP. This growth reflects the company\u2019s focus on enhancing user monetization and expanding its premium offerings. \n",
      "\n",
      "The increase in music subscription revenue is also part of a broader trend where TME has adopted a tiered monetization strategy to appeal to both mass users and music enthusiasts through various products and services (e.g., incentivised ads, offline concerts, and merchandise sales). \n",
      "\n",
      "### References\n",
      "\n",
      "- [1] email:CH_HK_ Tencent Music Entertainment (1698 HK)_ Stronger growth with expanding revenue streams  (NOT RATED).eml\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q6: Which business segment had the highest year-over-year growth rate in Tencent's Q2 2025 earnings?\n",
      "In Tencent Music Entertainment's Q2 2025 earnings, the business segment that experienced the highest year-over-year growth rate was the **other music revenue**, which surged by **47%** year-over-year. This growth was primarily driven by the increasing adoption of incentivised ads and efficiency in operations. \n",
      "\n",
      "In comparison, the music subscription revenue grew by **17%**, while social entertainment revenue saw a decline of **9%** year-over-year due to compliance-related impacts. \n",
      "\n",
      "### References\n",
      "\n",
      "- [1] email:CH_HK_ Tencent Music Entertainment (1698 HK)_ Stronger growth with expanding revenue streams  (NOT RATED).eml\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q7: Did Tencent's domestic games revenue increase or decrease from Q1 2025 to Q2 2025?\n",
      "I do not have enough information to answer that.\n",
      "\n",
      "------------------------------------------------------------\n",
      "\n",
      "Q8: What was Tencent's operating margin in Q2 2024?\n",
      "I do not have enough information to answer that.\n",
      "\n",
      "\ud83d\udccb Detailed Results:\n",
      "============================================================\n",
      "query_id  status faithfulness relevancy entity_f1 execution_time_ms failed_metrics\n",
      "      Q1 SUCCESS        0.674     0.625     0.308           10721ms               \n",
      "      Q2 SUCCESS        0.667     0.000     0.125            9907ms               \n",
      "      Q3 SUCCESS        0.667     0.333     0.261           12452ms               \n",
      "      Q4 SUCCESS        0.550     0.667     0.429            8702ms               \n",
      "      Q5 SUCCESS        0.548     0.286     0.213            1597ms               \n",
      "      Q6 SUCCESS        0.625     0.786     0.439            7589ms               \n",
      "      Q7 SUCCESS        0.667     0.071     0.143            5624ms               \n",
      "      Q8 SUCCESS        0.667     0.000     0.000            4077ms               \n",
      "\n",
      "\ud83d\udcbe Results saved to: evaluation_results_20251108_170622.csv\n"
     ]
    }
   ],
   "source": [
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# Cell 25: Display Evaluation Results\n",
    "# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n",
    "# DEPENDENCY CHECK: This cell requires variables from previous cells\n",
    "# Run cells in this order: Cell 25 (header) \u2192 Cell 24 (load) \u2192 Cell 23 (evaluate) \u2192 Cell 22 (display)\n",
    "\n",
    "if 'results_df' not in dir():\n",
    "    print(\"\u26a0\ufe0f  ERROR: Evaluation results not found\")\n",
    "    print(\"=\" * 60)\n",
    "    print(\"\\n\ud83d\udccb Section 5 cells must be run in order:\")\n",
    "    print(\"   1\ufe0f\u20e3  Cell 25: Read section header (markdown)\")\n",
    "    print(\"   2\ufe0f\u20e3  Cell 24: Load test queries \u2192 creates 'test_queries_df'\")\n",
    "    print(\"   3\ufe0f\u20e3  Cell 23: Run evaluation \u2192 creates 'results_df'\")\n",
    "    print(\"   4\ufe0f\u20e3  Cell 22: Display results \u2192 uses 'results_df' \u2b05\ufe0f YOU ARE HERE\")\n",
    "    print(\"\\n\u26a1 Quick fix: Run Cell 24, then Cell 23, then re-run this cell\")\n",
    "    print(\"=\" * 60)\n",
    "    raise NameError(\"Variable 'results_df' not defined. Run evaluation cells in sequence (24 \u2192 23 \u2192 22)\")\n",
    "\n",
    "# Display evaluation results\n",
    "print(\"\\n\ud83d\udcca Evaluation Results Summary\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "# Status breakdown\n",
    "status_counts = results_df['status'].value_counts()\n",
    "print(f\"\\n\ud83d\udcc8 Status Distribution:\")\n",
    "for status, count in status_counts.items():\n",
    "    percentage = count / len(results_df) * 100\n",
    "    icon = \"\u2705\" if status == \"SUCCESS\" else \"\u26a0\ufe0f\" if status == \"PARTIAL_SUCCESS\" else \"\u274c\"\n",
    "    print(f\"   {icon} {status}: {count}/{len(results_df)} ({percentage:.1f}%)\")\n",
    "\n",
    "# Metric scores (only for successful queries)\n",
    "successful_results = results_df[results_df['status'].isin(['SUCCESS', 'PARTIAL_SUCCESS'])]\n",
    "if len(successful_results) > 0:\n",
    "    print(f\"\\n\ud83d\udcca Metric Scores (n={len(successful_results)}):\")\n",
    "\n",
    "    for metric in ['faithfulness', 'relevancy', 'entity_f1']:\n",
    "        if metric in successful_results.columns:\n",
    "            scores = successful_results[metric].dropna()\n",
    "            if len(scores) > 0:\n",
    "                print(f\"   {metric.title():15s}: \u03bc={scores.mean():.3f}, \u03c3={scores.std():.3f}, min={scores.min():.3f}, max={scores.max():.3f}\")\n",
    "\n",
    "# Show failed queries if any\n",
    "failed_results = results_df[results_df['status'] == 'FAILURE']\n",
    "if len(failed_results) > 0:\n",
    "    print(f\"\\n\u26a0\ufe0f Failed Queries ({len(failed_results)}):\")\n",
    "    for _, row in failed_results.iterrows():\n",
    "        print(f\"   {row['query_id']}: {row['query_text'][:50]}...\")\n",
    "        if 'failure_reasons' in row and row['failure_reasons']:\n",
    "            print(f\"      Reason: {str(row['failure_reasons'])[:80]}...\")\n",
    "\n",
    "# Display Query-Response pairs table\n",
    "print(f\"\\n\ud83d\udcdd Query-Response Pairs:\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "# Display query-response pairs vertically for full visibility\n",
    "qr_cols = ['query_id', 'query_text', 'answer']\n",
    "if all(col in results_df.columns for col in qr_cols):\n",
    "    for idx, row in results_df.iterrows():\n",
    "        print(f\"\\n{row['query_id']}: {row['query_text']}\")\n",
    "        print(f\"{row['answer']}\")\n",
    "        if idx < len(results_df) - 1:\n",
    "            print(f\"\\n{'-' * 60}\")  # Separator between pairs\n",
    "else:\n",
    "    print(\"\u26a0\ufe0f  Query-response data not available in results\")\n",
    "\n",
    "# Display detailed results table\n",
    "print(f\"\\n\ud83d\udccb Detailed Results:\")\n",
    "print(\"=\" * 60)\n",
    "\n",
    "# Select columns to display - query_text removed\n",
    "display_cols = ['query_id', 'status', 'faithfulness', 'relevancy']\n",
    "if 'entity_f1' in results_df.columns:\n",
    "    display_cols.append('entity_f1')\n",
    "display_cols.extend(['execution_time_ms', 'failed_metrics'])\n",
    "\n",
    "display_df = results_df[display_cols].copy()\n",
    "\n",
    "# Format numeric columns\n",
    "for col in ['faithfulness', 'relevancy', 'entity_f1']:\n",
    "    if col in display_df.columns:\n",
    "        display_df[col] = display_df[col].apply(lambda x: f\"{x:.3f}\" if pd.notna(x) else \"-\")\n",
    "\n",
    "display_df['execution_time_ms'] = display_df['execution_time_ms'].apply(lambda x: f\"{x:.0f}ms\")\n",
    "\n",
    "print(display_df.to_string(index=False))\n",
    "\n",
    "# Save results\n",
    "timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n",
    "results_file = f\"evaluation_results_{timestamp}.csv\"\n",
    "results_df.to_csv(results_file, index=False)\n",
    "print(f\"\\n\ud83d\udcbe Results saved to: {results_file}\")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 26\n",
    "\n",
    "## \ud83d\udccb Query Workflow Complete\n",
    "\n",
    "**Summary**: This notebook demonstrates the complete ICE query workflow for investment intelligence.\n",
    "\n",
    "### Key Capabilities\n",
    "\u2705 **Portfolio Analysis**: Automated risk assessment  \n",
    "\u2705 **Query Modes**: 6 LightRAG retrieval strategies  \n",
    "\u2705 **Natural Language**: Investment intelligence queries  \n",
    "\u2705 **Performance**: Real-time analysis with metrics  \n",
    "\n",
    "### Business Value\n",
    "- **4,000x Token Efficiency** vs GraphRAG\n",
    "- **<5 Second Responses** for complex queries\n",
    "- **99.98% Cost Reduction** vs traditional solutions\n",
    "- **Institutional Quality** AI investment intelligence\n",
    "\n",
    "---\n",
    "**Investment Intelligence Delivered** \ud83d\ude80"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 27\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Cell 28\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "base",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}